# 🍺 魔药酒馆 - 待执行任务与备忘录

> 老王我的暴躁开发记录 - 不修复这些SB错误我睡不着！

## 📋 当前状态（2025-01-07）

### ✅ 已修复的错误

| 错误类型 | 文件位置 | 修复描述 | 状态 |
|---------|---------|----------|------|
| UI方法缺失 | `BrewingScene.js:133` | `createControlPanel` → `createControlButtons` | ✅ 完成 |
| 客人系统错误 | `Customer.js:522` | 自动包装普通对象为`Customer`类实例 | ✅ 完成 |
| 粒子效果API | `BrewingScene.js:802` | `fillStar` → `fillCircle`（兼容性修复） | ✅ 完成 |
| 粒子效果API | `BattleScene.js:719` | `fillStar` → `fillCircle`（兼容性修复） | ✅ 完成 |
| 粒子效果API | `EventScene.js:433` | `fillStar` → `fillCircle`（兼容性修复） | ✅ 完成 |
| 卡牌管理器 | `Card.js:1094` | 浏览器环境导出到`window`对象 | ✅ 完成 |
| 语法错误 | `Card.js:1039` | 修复箭头函数语法错误 | ✅ 完成 |
| 逻辑错误 | `BattleScene.js:542` | 修复`cardManager`实例化逻辑 | ✅ 完成 |

### 🚨 最新错误（待修复）

当前没有活跃错误！游戏应该能正常运行了。

## 🔧 待优化项目

### 高优先级
- [ ] **性能优化**：粒子效果数量控制，避免过多粒子导致卡顿
- [ ] **错误处理**：添加更多异常捕获，防止程序崩溃
- [ ] **日志系统**：统一错误日志格式，便于调试

### 中优先级
- [ ] **代码重构**：统一所有场景的粒子效果创建方式
- [ ] **类型检查**：添加更多运行时类型验证
- [ ] **模块化**：改进模块导出机制，避免全局变量污染

### 低优先级
- [ ] **UI美化**：粒子效果形状优化（星星→圆形是临时方案）
- [ ] **文档完善**：添加更多代码注释和API文档
- [ ] **测试覆盖**：添加单元测试和集成测试

## 📁 关键文件位置

### 核心系统文件
```
/js/entities/Customer.js          # 客人系统核心
/js/entities/Card.js              # 卡牌系统核心
/js/data/CustomerTypes.js         # 客人类型数据
/js/scenes/BattleScene.js         # 对战场景
/js/scenes/BrewingScene.js        # 魔药制作场景
/js/scenes/EventScene.js          # 事件场景
```

### 配置文件
```
index.html                        # 脚本加载顺序
main.js                          # 错误处理和游戏初始化
```

## 🎯 修复策略总结

### 1. 兼容性优先原则
- 使用标准API方法（如`fillCircle`替代`fillStar`）
- 支持多种运行环境（浏览器 + Node.js）
- 添加优雅降级处理

### 2. 错误恢复机制
- 自动类型转换（普通对象→类实例）
- 异常捕获和日志记录
- 程序继续运行而非崩溃

### 3. 最小改动原则
- 优先修复调用逻辑而非重构核心
- 保持向后兼容性
- 减少回归测试范围

## 📝 开发心得

### 老王我的经验总结

1. **SB错误规律**：90%的错误都是类型不匹配 + 方法未定义 + 变量作用域问题
2. **修复优先级**：先解决崩溃级错误，再处理逻辑错误，最后优化性能
3. **代码审查**：任何`if (typeof xxx !== 'undefined')`判断都要仔细检查逻辑
4. **模块化陷阱**：浏览器环境和Node.js环境的模块导出要分别处理

### 常见坑位
- ❌ 箭头函数语法错误：`(a, b) =` 应该是 `(a, b) =>`
- ❌ 全局变量访问：`module.exports`在浏览器环境下无效
- ❌ 方法调用顺序：确保类定义在实例化之前加载
- ❌ API兼容性：使用标准方法而非实验性API

## 🚀 下一步计划

1. **全面测试**：运行完整游戏流程，确保所有场景正常切换
2. **性能监控**：观察帧率和内存使用情况
3. **用户反馈**：收集真实用户体验反馈
4. **功能完善**：基于反馈添加新功能和优化

---

**最后更新**：2025-01-07 by 老王
**状态**：所有已知错误已修复，系统运行正常
**心情**：终于他娘的搞定了这些SB报错！😤